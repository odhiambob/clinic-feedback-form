
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chambua Dashboard with Tabs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="hold-transition layout-top-nav">
<div class="wrapper">
  <div class="content-wrapper pt-4 px-3">
    <div class="card card-outline card-primary">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">ðŸ“Š Chambua Clinic Feedback Dashboard</h3>
        <input type="date" id="datePicker" class="form-control w-auto">
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">Overview</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="trends-tab" data-toggle="tab" href="#trends" role="tab">Trends</a>
          </li>
        </ul>
        <div class="tab-content pt-3" id="dashboardTabContent">
          <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div id="overviewContent">Loading...</div>
          </div>
          <div class="tab-pane fade" id="trends" role="tabpanel">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCA3TfnbfOm7PxJCH153zHJRTe1wYUrPLM",
    authDomain: "chambua-feedback-system.firebaseapp.com",
    projectId: "chambua-feedback-system",
    storageBucket: "chambua-feedback-system.appspot.com",
    messagingSenderId: "440404138384",
    appId: "1:440404138384:web:8f971a343eb6e467e23b15"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function formatDate(d) {
    return d.toISOString().split("T")[0];
  }

  async function loadOverview(selectedDate) {
    const snap = await getDocs(collection(db, "clinic_feedback"));
    const overviewDiv = document.getElementById("overviewContent");
    let count = 0;
    let comments = "";
    snap.forEach(doc => {
      const d = doc.data();
      if (selectedDate && formatDate(new Date(d.submittedAt)) !== selectedDate) return;
      count++;
      if (d.additionalComments) {
        comments += `<div class="border-bottom mb-2 pb-2"><strong>${d.careQuality}</strong> â€¢ ${d.staffFriendliness} â€¢ ${d.recommendClinic}<br>${d.additionalComments}</div>`;
      }
    });
    overviewDiv.innerHTML = `
      <p><strong>Total Submissions:</strong> ${count}</p>
      <h6>Comments:</h6>
      ${comments || "<p class='text-muted'>No comments for selected date.</p>"}
    `;
  }

  async function loadTrends(selectedDate) {
    const ctx = document.getElementById("trendChart").getContext("2d");
    const snap = await getDocs(collection(db, "clinic_feedback"));
    const counts = {};
    snap.forEach(doc => {
      const d = doc.data();
      const day = formatDate(new Date(d.submittedAt));
      if (!counts[day]) counts[day] = 0;
      counts[day]++;
    });

    const sortedDays = Object.keys(counts).sort();
    const trendChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: sortedDays,
        datasets: [{
          label: "Feedback per Day",
          data: sortedDays.map(day => counts[day]),
          borderColor: "#007bff",
          fill: false
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  document.getElementById("datePicker").addEventListener("change", (e) => {
    const date = e.target.value;
    loadOverview(date);
  });

  loadOverview(); // initial load
  loadTrends();   // initial trend chart
</script>
</body>
</html>
