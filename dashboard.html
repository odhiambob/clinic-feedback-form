<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chambua Clinic Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; }
    .sidebar {
      width: 220px; height: 100vh; background-color: #343a40;
      position: fixed; top: 0; left: 0; padding-top: 20px; color: white;
    }
    .sidebar a { display: block; padding: 12px 20px; color: white; text-decoration: none; }
    .sidebar a.active, .sidebar a:hover { background-color: #495057; }
    .main { margin-left: 220px; padding: 30px 20px; max-width: 1140px; }
    .kpi-box { border-radius: 5px; padding: 15px; color: white; text-align: center; }
    .kpi-blue { background-color: #17a2b8; }
    .kpi-green { background-color: #28a745; }
    .kpi-yellow { background-color: #ffc107; color: #333; }
    .card-header { font-weight: bold; }
    .comment-card {
      padding: 10px; border-left: 5px solid #17a2b8;
      margin-bottom: 10px; background-color: white;
    }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    #loginContainer {
      max-width: 400px; margin: 100px auto; padding: 30px;
      background: #fff; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .export-btn { float: right; margin-top: -10px; }
  </style>
</head>
<body>

<!-- Firebase Config -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCA3TfnbfOm7PxJCH153zHJRTe1wYUrPLM",
    authDomain: "chambua-feedback-system.firebaseapp.com",
    projectId: "chambua-feedback-system",
    storageBucket: "chambua-feedback-system.appspot.com",
    messagingSenderId: "440404138384",
    appId: "1:440404138384:web:8f971a343eb6e467e23b15"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
</script>

<!-- Login UI -->
<div id="loginContainer" style="display:none;">
  <h4 class="text-center mb-4">üîê Admin Login</h4>
  <div class="mb-3"><input type="email" id="loginEmail" class="form-control" placeholder="Email" /></div>
  <div class="mb-3"><input type="password" id="loginPassword" class="form-control" placeholder="Password" /></div>
  <div class="d-grid gap-2">
    <button class="btn btn-primary" onclick="loginWithEmail()">Login with Email</button>
    <button class="btn btn-danger" onclick="loginWithGoogle()">Login with Google</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboardContent" style="display:none;">
  <div class="sidebar">
    <h5 class="text-center mb-4">üìä Chambua Dashboard</h5>
    <a href="#" class="active" onclick="showTab('dashboardTab')">Dashboard</a>
    <a href="#" onclick="showTab('trendTab')">Trends</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div class="main">
    <div class="dashboard-header text-center mb-4">
      <h2>Clinic Feedback Summary</h2>
      <input type="date" id="dateFilter" class="form-control w-auto mx-auto" />
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="tab-pane active">
      <div class="row">
        <div class="col-md-4"><div class="kpi-box kpi-blue"><h2 id="totalSubmissions">0</h2><p>Total Submissions</p></div></div>
        <div class="col-md-4"><div class="kpi-box kpi-green"><h2 id="wouldRecommend">0</h2><p>Would Recommend</p></div></div>
        <div class="col-md-4"><div class="kpi-box kpi-yellow"><h2 id="excellentCare">0</h2><p>Excellent Care</p></div></div>
      </div>

      <div class="row mt-4">
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-primary text-white">Care Quality <button class="btn btn-light btn-sm export-btn" onclick="exportChart('careChart')">Export</button></div>
            <div class="card-body"><canvas id="careChart"></canvas></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-info text-white">Wait Time <button class="btn btn-light btn-sm export-btn" onclick="exportChart('waitTimeChart')">Export</button></div>
            <div class="card-body"><canvas id="waitTimeChart"></canvas></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-header text-white" style="background-color: #6f42c1;">Friendliness <button class="btn btn-light btn-sm export-btn" onclick="exportChart('friendlinessChart')">Export</button></div>
            <div class="card-body"><canvas id="friendlinessChart"></canvas></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-header bg-success text-white">Recommend? <button class="btn btn-light btn-sm export-btn" onclick="exportChart('recommendChart')">Export</button></div>
            <div class="card-body"><canvas id="recommendChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header bg-secondary text-white">Client Comments</div>
        <div class="card-body" id="commentsSection"></div>
      </div>
    </div>

    <!-- Trends Tab -->
    <div id="trendTab" class="tab-pane">
      <h4 class="mb-3">Feedback Trends</h4>
      <div class="row">
        <div class="col-md-3"><label>Start Date</label><input type="date" class="form-control" id="startDate"></div>
        <div class="col-md-3"><label>End Date</label><input type="date" class="form-control" id="endDate"></div>
        <div class="col-md-3"><label>Trend Variable</label><select class="form-control" id="trendVariable"><option value="recommendClinic">Would Recommend</option><option value="careQuality">Care Quality</option><option value="waitTime">Wait Time</option><option value="staffFriendliness">Staff Friendliness</option></select></div>
        <div class="col-md-3 mt-4"><button class="btn btn-primary mt-2" onclick="filterTrends()">Apply Filter</button></div>
      </div>
      <div class="chart-wrapper mt-4"><canvas id="trendChart" height="100"></canvas></div>
    </div>
  </div>
</div>
<script>
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("dashboardContent").style.display = "block";
      loadDashboardData();
    } else {
      document.getElementById("loginContainer").style.display = "block";
      document.getElementById("dashboardContent").style.display = "none";
    }
  });

  function loginWithEmail() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    auth.signInWithEmailAndPassword(email, password).catch(alert);
  }

  function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(alert);
  }

  function logout() { auth.signOut(); }

  function showTab(tabId) {
    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
    event.target.classList.add('active');
  }

  function exportChart(canvasId) {
    html2canvas(document.getElementById(canvasId)).then(canvas => {
      const link = document.createElement('a');
      link.download = `${canvasId}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
  }

  let feedbackData = [];

  function loadDashboardData() {
    db.collection("clinic_feedback").orderBy("submittedAt", "desc").onSnapshot(snapshot => {
      feedbackData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateDashboard();
    });
  }

  function updateDashboard() {
    const total = feedbackData.length;
    const recommend = feedbackData.filter(f => f.recommendClinic === "Yes").length;
    const excellentCare = feedbackData.filter(f => f.careQuality === "Excellent").length;
    document.getElementById("totalSubmissions").innerText = total;
    document.getElementById("wouldRecommend").innerText = recommend;
    document.getElementById("excellentCare").innerText = excellentCare;

    updateChart("careChart", ["Excellent", "Good", "Average", "Poor"], f => f.careQuality);
    updateChart("waitTimeChart", ["Less than 15 minutes", "15‚Äì30 minutes", "More than 30 minutes"], f => f.waitTime);
    updateChart("friendlinessChart", ["Excellent", "Good", "Average", "Poor"], f => f.staffFriendliness);
    updateChart("recommendChart", ["Yes", "No"], f => f.recommendClinic);

    const comments = feedbackData
      .filter(f => f.additionalComments)
      .map(f => `<div class="comment-card">${f.additionalComments} ‚Ä¢ ${f.recommendClinic} ‚Ä¢ ${f.submittedAt?.toDate().toLocaleString() || ''}</div>`)
      .join("");
    document.getElementById("commentsSection").innerHTML = comments;
  }

  function updateChart(canvasId, labels, extractor) {
    const counts = labels.map(label => feedbackData.filter(f => extractor(f) === label).length);
    const colors = ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1'];
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (window[canvasId]) window[canvasId].destroy();
    window[canvasId] = new Chart(ctx, {
      type: canvasId === "recommendChart" || canvasId === "careChart" ? "pie" : "bar",
      data: {
        labels,
        datasets: [{ data: counts, backgroundColor: colors }]
      },
      options: { responsive: true, legend: { position: 'bottom' } }
    });
  }

  function filterTrends() {
    const start = new Date(document.getElementById("startDate").value);
    const end = new Date(document.getElementById("endDate").value);
    end.setHours(23, 59, 59);
    const trendKey = document.getElementById("trendVariable").value;

    const filtered = feedbackData.filter(f => {
      const date = f.submittedAt?.toDate?.();
      return (!start || !date || date >= start)
          && (!end || !date || date <= end);
    });

    const dateMap = {};
    filtered.forEach(f => {
      const date = f.submittedAt?.toDate()?.toLocaleDateString();
      if (!date) return;
      const value = f[trendKey];
      if (!value) return;
      if (!dateMap[date]) dateMap[date] = {};
      dateMap[date][value] = (dateMap[date][value] || 0) + 1;
    });

    const allDates = Object.keys(dateMap).sort();
    const allLabels = [...new Set(filtered.map(f => f[trendKey]))];

    const datasets = allLabels.map(label => ({
      label,
      data: allDates.map(date => dateMap[date]?.[label] || 0),
      borderColor: getRandomColor(),
      fill: false
    }));

    const trendCtx = document.getElementById("trendChart").getContext('2d');
    if (window.trendChart) window.trendChart.destroy();
    window.trendChart = new Chart(trendCtx, {
      type: "line",
      data: { labels: allDates, datasets },
      options: {
        responsive: true,
        title: { display: true, text: `Trend: ${trendKey}` },
        scales: { yAxes: [{ ticks: { beginAtZero: true, precision: 0 } }] }
      }
    });
  }

  function getRandomColor() {
    const palette = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#fd7e14'];
    return palette[Math.floor(Math.random() * palette.length)];
  }
</script>
</body>
</html>
