
<!-- ✅ Part 0 of dashboard.html: Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- ✅ Part 1 of dashboard.html: Boilerplate and Firebase config -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chambua Clinic Feedback Dashboard</title>

  <!-- Bootstrap + Chart.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
    }
    .sidebar {
      width: 220px;
      height: 100vh;
      background-color: #343a40;
      position: fixed;
      top: 0;
      left: 0;
      color: white;
      padding-top: 20px;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
    }
    .sidebar a.active,
    .sidebar a:hover {
      background-color: #495057;
    }
    .main {
      margin-left: 220px;
      padding: 30px 20px;
      max-width: 1140px;
    }
    .kpi-box {
      border-radius: 5px;
      padding: 15px;
      color: white;
      text-align: center;
    }
    .kpi-blue { background-color: #17a2b8; }
    .kpi-green { background-color: #28a745; }
    .kpi-yellow { background-color: #ffc107; color: #333; }
    .card-header { font-weight: bold; }
    .comment-card {
      padding: 10px;
      border-left: 5px solid #17a2b8;
      margin-bottom: 10px;
      background-color: white;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }
    .bar-label {
      font-size: 14px;
      font-weight: bold;
      fill: white;
      text-anchor: middle;
    }
  </style>
</head>

<!-- ✅ Part 2 of dashboard.html: Body, Sidebar, and Tabs -->
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5 class="text-center mb-4">📊 Chambua Dashboard</h5>
    <a href="#" class="active" onclick="showTab('dashboardTab')">Dashboard</a>
    <a href="#" onclick="showTab('trendTab')">Trends</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
  
  <!-- Main Content -->
  <div class="main">
    <div class="dashboard-header">
      <h2>Clinic Feedback Summary</h2>
      <p>Showing results for: <span id="currentDateLabel"></span></p>
      <input type="date" id="dateFilter" class="form-control w-auto mx-auto"/>
    </div>
  
    <!-- Tabs Start -->
    <div id="dashboardTab" class="tab-pane active">

    <!-- KPI Cards -->
    <div class="row">
      <div class="col-md-4">
        <div class="kpi-box kpi-blue">
          <h2 id="totalSubmissions">0</h2>
          <p>Total Submissions</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-box kpi-green">
          <h2 id="wouldRecommend">0</h2>
          <p>Would Recommend</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-box kpi-yellow">
          <h2 id="excellentCare">0</h2>
          <p>Excellent Care</p>
        </div>
      </div>
    </div>

    <!-- Feedback Charts -->
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-primary text-white">Care Quality</div>
          <div class="card-body">
            <canvas id="careChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-info text-white">Wait Time</div>
          <div class="card-body">
            <canvas id="waitTimeChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header text-white" style="background-color: #6f42c1;">Staff Friendliness</div>
          <div class="card-body">
            <canvas id="friendlinessChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-success text-white">Would Recommend?</div>
          <div class="card-body">
            <canvas id="recommendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="card mt-4">
      <div class="card-header bg-secondary text-white">Client Comments & Suggestions</div>
      <div class="card-body" id="commentsSection">
        <!-- Comments will be dynamically added here -->
      </div>
    </div>
  </div> <!-- End Dashboard Tab -->

  <!-- Trends Tab -->
  <div id="trendTab" class="tab-pane">
    <h4>Feedback Trends</h4>
    <p>Select a date range and variables to analyze trends over time.</p>

    <div class="form-inline mb-3">
      <label for="startDate">Start: </label>
      <input type="date" id="startDate" class="form-control mx-2"/>
      <label for="endDate">End: </label>
      <input type="date" id="endDate" class="form-control mx-2"/>
      <button class="btn btn-primary" onclick="filterTrends()">Apply Filter</button>
    </div>

    <!-- Variable Checklist -->
    <div class="form-group">
      <label><strong>Select Variables:</strong></label>
      <div id="variableFilter">
        <div><input type="checkbox" class="trend-var" value="recommendClinic" checked> Would Recommend</div>
        <div><input type="checkbox" class="trend-var" value="careQuality" checked> Care Quality</div>
        <div><input type="checkbox" class="trend-var" value="waitTime" checked> Wait Time</div>
        <div><input type="checkbox" class="trend-var" value="staffFriendliness" checked> Staff Friendliness</div>
      </div>
    </div>

    <div class="mt-4">
      <canvas id="trendChart" height="100"></canvas>
    </div>
  </div> <!-- End Trends Tab -->
</div> <!-- End Main -->

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- Part 1 of login: Firebase Config -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCA3TfnbfOm7PxJCH153zHJRTe1wYUrPLM",
    authDomain: "chambua-feedback-system.firebaseapp.com",
    projectId: "chambua-feedback-system",
    storageBucket: "chambua-feedback-system.appspot.com",
    messagingSenderId: "440404138384",
    appId: "1:440404138384:web:8f971a343eb6e467e23b15"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
</script>

<!-- Part 2 of login: Login Logic for Email/Password and Google -->
<script>
  // Redirect to login.html if not logged in
  auth.onAuthStateChanged((user) => {
    if (!user) {
      window.location.href = "login.html";
    }
  });

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  }
</script>

<!-- Part 3 of dashboard.html: Tab Control, Date Logic, Chart References -->
<script>
  // Show correct tab
  function showTab(tabId) {
    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
    event.target.classList.add('active');
  }

  // Set default date to today
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("dateFilter").value = today;
  document.getElementById("currentDateLabel").textContent = today;

  // Chart references
  let careChart, waitTimeChart, friendlinessChart, recommendChart, trendChart;

  // Initialize all charts as empty pie charts (they’ll be updated by Firestore later)
  function createPieChart(ctx, labels, values, colors) {
    return new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        legend: { position: 'bottom' },
        plugins: {
          datalabels: {
            formatter: (value, ctx) => `${value}%`,
            color: '#fff'
          }
        }
      }
    });
  }
</script>

<!-- Part 4 of dashboard.html: Load and Update Dashboard Charts from Firestore -->
<script>
  // Update dashboard view based on date
  async function updateDashboard(selectedDate) {
    const snapshot = await db.collection("clinic_feedback")
      .where("submittedAt", ">=", new Date(selectedDate + "T00:00:00"))
      .where("submittedAt", "<=", new Date(selectedDate + "T23:59:59"))
      .get();

    const data = snapshot.docs.map(doc => doc.data());

    // KPI counts
    document.getElementById("totalSubmissions").innerText = data.length;
    document.getElementById("wouldRecommend").innerText =
      data.filter(d => d.recommendClinic === "Yes").length;
    document.getElementById("excellentCare").innerText =
      data.filter(d => d.careQuality === "Excellent").length;

    // Build chart data
    const countBy = (arr, key) => {
      return arr.reduce((acc, item) => {
        const val = item[key] || "Undefined";
        acc[val] = (acc[val] || 0) + 1;
        return acc;
      }, {});
    };

    const piePercentages = (counts) => {
      const total = Object.values(counts).reduce((a, b) => a + b, 0);
      return Object.keys(counts).map(k => Math.round((counts[k] / total) * 100));
    };

    const labelsMap = {
      careQuality: ["Excellent", "Good", "Average", "Poor"],
      waitTime: ["Less than 15 minutes", "15–30 minutes", "More than 30 minutes"],
      staffFriendliness: ["Excellent", "Good", "Average", "Poor"],
      recommendClinic: ["Yes", "No"]
    };

    const colorsMap = {
      careQuality: ["#28a745", "#007bff", "#ffc107", "#dc3545"],
      waitTime: ["#17a2b8", "#ffc107", "#dc3545"],
      staffFriendliness: ["#6f42c1", "#007bff", "#ffc107", "#dc3545"],
      recommendClinic: ["#28a745", "#dc3545"]
    };

    // Updated: Reusable updateChart function
    const updateChart = (refName, canvasId, labels, counts, colors) => {
      const values = piePercentages(counts);
      const ctx = document.getElementById(canvasId)?.getContext("2d");
      if (!ctx) return;

      // Destroy old chart if it exists
      if (refName && typeof refName.destroy === "function") {
        refName.destroy();
      }

      const newChart = createPieChart(ctx, labels, values, colors);
      return newChart;
    };

    careChart = updateChart(careChart, "careChart", labelsMap.careQuality, countBy(data, "careQuality"), colorsMap.careQuality);
    waitTimeChart = updateChart(waitTimeChart, "waitTimeChart", labelsMap.waitTime, countBy(data, "waitTime"), colorsMap.waitTime);
    friendlinessChart = updateChart(friendlinessChart, "friendlinessChart", labelsMap.staffFriendliness, countBy(data, "staffFriendliness"), colorsMap.staffFriendliness);
    recommendChart = updateChart(recommendChart, "recommendChart", labelsMap.recommendClinic, countBy(data, "recommendClinic"), colorsMap.recommendClinic);

    // Display comments
    const commentsEl = document.getElementById("commentsSection");
    commentsEl.innerHTML = "";
    data.forEach(d => {
      const comment = d.additionalComments || "";
      const rec = d.recommendClinic || "";
      const care = d.careQuality || "";
      const date = d.submittedAt?.toDate?.().toLocaleString?.() || "";
      commentsEl.innerHTML += `<div class="comment-card">${comment} • ${care} • ${rec} • ${date}</div>`;
    });
  }

  // Trigger update on load
  updateDashboard(today);

  // Trigger update when date changes
  document.getElementById("dateFilter").addEventListener("change", e => {
    const chosen = e.target.value;
    document.getElementById("currentDateLabel").textContent = chosen;
    updateDashboard(chosen);
  });
</script>

<!-- Part 5 of dashboard.html: Trends Chart with Variable Filtering -->
<script>
  const trendVariables = ["careQuality", "waitTime", "staffFriendliness", "recommendClinic"];
  const trendColors = {
    careQuality: ["#28a745", "#007bff", "#ffc107", "#dc3545"],
    waitTime: ["#17a2b8", "#ffc107", "#dc3545"],
    staffFriendliness: ["#6f42c1", "#007bff", "#ffc107", "#dc3545"],
    recommendClinic: ["#28a745", "#dc3545"]
  };

  const trendLabels = {
    careQuality: ["Excellent", "Good", "Average", "Poor"],
    waitTime: ["Less than 15 minutes", "15–30 minutes", "More than 30 minutes"],
    staffFriendliness: ["Excellent", "Good", "Average", "Poor"],
    recommendClinic: ["Yes", "No"]
  };

  // Recreate checklist UI safely
  const trendSelect = document.createElement("select");
  trendSelect.id = "trendVariable";
  trendSelect.classList.add("form-control", "w-auto", "mx-2");
  document.getElementById("variableFilter").appendChild(trendSelect);

  trendVariables.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v.replace(/([A-Z])/g, ' $1').trim();
    trendSelect.appendChild(opt);
  });

  trendSelect.value = "recommendClinic";

  let trendBarChart = null;

  async function updateTrendChart() {
    const variable = trendSelect.value;
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const formatDate = (d) =>
      `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

    const fetchByDate = async (dateStr) => {
      const start = new Date(dateStr + "T00:00:00");
      const end = new Date(dateStr + "T23:59:59");

      const snap = await db.collection("clinic_feedback")
        .where("submittedAt", ">=", start)
        .where("submittedAt", "<=", end)
        .get();

      return snap.docs.map(d => d.data());
    };

    const dataToday = await fetchByDate(formatDate(today));
    const dataYesterday = await fetchByDate(formatDate(yesterday));

    const countBy = (data, key) => {
      return trendLabels[key].map(label =>
        data.filter(d => d[key] === label).length
      );
    };

    const yesterdayCounts = countBy(dataYesterday, variable);
    const todayCounts = countBy(dataToday, variable);

    const ctx = document.getElementById("trendChart")?.getContext("2d");
    if (!ctx) return;

    // Clean up old chart safely
    if (trendBarChart && typeof trendBarChart.destroy === "function") {
      trendBarChart.destroy();
    }

    trendBarChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: trendLabels[variable],
        datasets: [
          {
            label: "Yesterday",
            data: yesterdayCounts,
            backgroundColor: trendColors[variable],
          },
          {
            label: "Today",
            data: todayCounts,
            backgroundColor: trendColors[variable].map(c => c + "88"),
          },
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function (context) {
                const value = context.raw;
                return `${context.dataset.label}: ${value}`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, display: false },
          x: {
            ticks: {
              callback: function (label) {
                return trendLabels[variable][label];
              }
            }
          }
        }
      }
    });
  }

  trendSelect.addEventListener("change", updateTrendChart);
  updateTrendChart(); // Initial load
</script>

<!-- ✅ Part 6 of dashboard.html: Export Charts to PNG and PDF -->
<!-- Export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  function exportChartAsPNG(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const image = canvas.toDataURL("image/png", 1.0);
    const link = document.createElement("a");
    link.href = image;
    link.download = canvasId + ".png";
    link.click();
  }

  async function exportChartAsPDF(canvasId, title = "Chart Export") {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const image = canvas.toDataURL("image/png", 1.0);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text(title, 15, 10);
    pdf.addImage(image, "PNG", 15, 20, 180, 100);
    pdf.save(canvasId + ".pdf");
  }
</script>

<script>
  // Add export buttons dynamically after charts load
  function addExportButtons() {
    const charts = [
      { id: "careChart", title: "Care Quality" },
      { id: "waitTimeChart", title: "Wait Time" },
      { id: "friendlinessChart", title: "Friendliness" },
      { id: "recommendChart", title: "Would Recommend" },
      { id: "trendChart", title: "Trends" }
    ];

    charts.forEach(({ id, title }) => {
      const canvas = document.getElementById(id);
      if (canvas && !document.getElementById(id + "_export")) {
        const btns = document.createElement("div");
        btns.id = id + "_export";
        btns.className = "mt-2 text-center";
        btns.innerHTML = `
          <button class="btn btn-sm btn-outline-secondary" onclick="exportChartAsPNG('${id}')">Export PNG</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="exportChartAsPDF('${id}', '${title}')">Export PDF</button>
        `;
        canvas.parentElement.appendChild(btns);
      }
    });
  }

  // Attach export buttons after charts are drawn
  setTimeout(addExportButtons, 3000); // Adjust if needed after testing
</script>

<!-- ✅ Part 7 of dashboard.html: Export ALL Charts at Once -->
<script>
  async function exportAllChartsAsPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const charts = [
      { id: "careChart", title: "Care Quality" },
      { id: "waitTimeChart", title: "Wait Time" },
      { id: "friendlinessChart", title: "Friendliness" },
      { id: "recommendChart", title: "Would Recommend" },
      { id: "trendChart", title: "Trends Over Time" }
    ];

    for (let i = 0; i < charts.length; i++) {
      const { id, title } = charts[i];
      const canvas = document.getElementById(id);
      if (!canvas) continue;

      const imgData = canvas.toDataURL("image/png", 1.0);
      if (i > 0) pdf.addPage();
      pdf.text(title, 15, 10);
      pdf.addImage(imgData, "PNG", 15, 20, 180, 100);
    }

    pdf.save("Clinic_Feedback_Charts.pdf");
  }

  function exportAllChartsAsPNGs() {
    const charts = [
      { id: "careChart", title: "Care_Quality" },
      { id: "waitTimeChart", title: "Wait_Time" },
      { id: "friendlinessChart", title: "Friendliness" },
      { id: "recommendChart", title: "Would_Recommend" },
      { id: "trendChart", title: "Trends" }
    ];

    charts.forEach(({ id, title }) => {
      const canvas = document.getElementById(id);
      if (!canvas) return;
      const image = canvas.toDataURL("image/png", 1.0);
      const link = document.createElement("a");
      link.href = image;
      link.download = `${title}.png`;
      link.click();
    });
  }
</script>

<!-- 📌 Export All Buttons (place this somewhere visible, e.g. below KPI cards or header) -->
<div class="text-center mt-4">
  <button class="btn btn-outline-primary mx-1" onclick="exportAllChartsAsPDF()">📄 Export All as PDF</button>
  <button class="btn btn-outline-success mx-1" onclick="exportAllChartsAsPNGs()">🖼️ Export All as PNGs</button>
</div>


