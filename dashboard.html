<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chambua Clinic Dashboard</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body { background-color: #f4f6f9; }
    .chart-card canvas { height: 200px !important; }
    #loginSection, #dashboardSection { display: none; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Login -->
    <div id="loginSection" class="text-center">
      <h3 class="mb-3">Clinic Admin Login</h3>
      <input id="loginEmail" class="form-control mb-2" type="email" placeholder="Email">
      <input id="loginPass" class="form-control mb-2" type="password" placeholder="Password">
      <button id="loginBtn" class="btn btn-primary">Login</button>
      <p class="text-danger mt-2" id="loginError"></p>
    </div>

    <!-- Dashboard -->
    <div id="dashboardSection">
      <h2 class="text-center text-primary mb-4">üìä Chambua Clinic Feedback Dashboard</h2>
      <div id="alertBox" class="alert alert-danger d-none">‚ö†Ô∏è A client selected "No" to recommending the clinic!</div>

      <div class="row text-white mb-3">
        <div class="col-md-4"><div class="bg-info p-3 rounded"><h4>Total Submissions</h4><h2 id="totalCount">0</h2></div></div>
        <div class="col-md-4"><div class="bg-success p-3 rounded"><h4>Would Recommend</h4><h2 id="recommendCount">0</h2></div></div>
        <div class="col-md-4"><div class="bg-warning p-3 rounded"><h4>Excellent Care</h4><h2 id="excellentCount">0</h2></div></div>
      </div>

      <div class="row">
        <div class="col-md-3 chart-card"><canvas id="careChart"></canvas></div>
        <div class="col-md-3 chart-card"><canvas id="waitChart"></canvas></div>
        <div class="col-md-3 chart-card"><canvas id="friendChart"></canvas></div>
        <div class="col-md-3 chart-card"><canvas id="recommendChart"></canvas></div>
      </div>

      <div class="card mt-4">
        <div class="card-header bg-dark text-white">Client Comments</div>
        <div class="card-body" id="commentList"></div>
      </div>

      <div class="table-responsive mt-4">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr><th>Care</th><th>Wait</th><th>Friendliness</th><th>Recommend?</th><th>Comment</th><th>Contact</th><th>Time</th></tr>
          </thead>
          <tbody id="feedbackTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCA3TfnbfOm7PxJCH153zHJRTe1wYUrPLM",
      authDomain: "chambua-feedback-system.firebaseapp.com",
      projectId: "chambua-feedback-system"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const careMap = { Excellent: 0, Good: 0, Average: 0, Poor: 0 };
    const waitMap = { "Less than 15 minutes": 0, "15‚Äì30 minutes": 0, "More than 30 minutes": 0 };
    const friendMap = { Excellent: 0, Good: 0, Average: 0, Poor: 0 };
    const recommendMap = { Yes: 0, No: 0 };

    let total = 0, recommend = 0, excellent = 0;

    const careChart = new Chart(document.getElementById("careChart"), {
      type: 'pie',
      data: { labels: Object.keys(careMap), datasets: [{ data: [], backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545'] }] },
      options: { plugins: { datalabels: { formatter: (v, ctx) => v + '%', color: '#fff' } } },
      plugins: [ChartDataLabels]
    });
    const waitChart = new Chart(document.getElementById("waitChart"), {
      type: 'bar',
      data: { labels: Object.keys(waitMap), datasets: [{ label: 'Wait Time', data: [], backgroundColor: '#17a2b8' }] },
      options: { scales: { y: { beginAtZero: true } }, plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v + '%' } } },
      plugins: [ChartDataLabels]
    });
    const friendChart = new Chart(document.getElementById("friendChart"), {
      type: 'bar',
      data: { labels: Object.keys(friendMap), datasets: [{ label: 'Friendliness', data: [], backgroundColor: '#6f42c1' }] },
      options: { scales: { y: { beginAtZero: true } }, plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v + '%' } } },
      plugins: [ChartDataLabels]
    });
    const recommendChart = new Chart(document.getElementById("recommendChart"), {
      type: 'doughnut',
      data: { labels: Object.keys(recommendMap), datasets: [{ data: [], backgroundColor: ['#28a745', '#dc3545'] }] },
      options: { plugins: { datalabels: { formatter: (v) => v + '%', color: '#fff' } } },
      plugins: [ChartDataLabels]
    });

    async function loadData() {
      const tableBody = document.getElementById("feedbackTableBody");
      const commentList = document.getElementById("commentList");
      const alertBox = document.getElementById("alertBox");

      const snapshot = await db.collection("clinic_feedback").get();
      snapshot.forEach(doc => {
        const d = doc.data();
        total++;
        if (d.recommendClinic === "Yes") recommend++;
        if (d.careQuality === "Excellent") excellent++;
        if (d.recommendClinic === "No") alertBox.classList.remove("d-none");

        careMap[d.careQuality]++;
        waitMap[d.waitTime]++;
        friendMap[d.staffFriendliness]++;
        recommendMap[d.recommendClinic]++;

        if (d.additionalComments) commentList.innerHTML += `<p><strong>${d.careQuality}</strong>: ${d.additionalComments}</p>`;

        tableBody.innerHTML += `<tr><td>${d.careQuality}</td><td>${d.waitTime}</td><td>${d.staffFriendliness}</td><td>${d.recommendClinic}</td><td>${d.additionalComments || ''}</td><td>${d.contactInfo || ''}</td><td>${new Date(d.submittedAt?.seconds * 1000).toLocaleString()}</td></tr>`;
      });

      document.getElementById("totalCount").textContent = total;
      document.getElementById("recommendCount").textContent = recommend;
      document.getElementById("excellentCount").textContent = excellent;

      careChart.data.datasets[0].data = Object.values(careMap);
      waitChart.data.datasets[0].data = Object.values(waitMap);
      friendChart.data.datasets[0].data = Object.values(friendMap);
      recommendChart.data.datasets[0].data = Object.values(recommendMap);

      careChart.update(); waitChart.update(); friendChart.update(); recommendChart.update();
    }

    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboardSection").style.display = "block";
        loadData();
      } catch (err) {
        document.getElementById("loginError").textContent = err.message;
      }
    };
  </script>
</body>
</html>
