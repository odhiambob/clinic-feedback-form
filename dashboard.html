<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chambua Clinic Feedback Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
    }
    .sidebar {
      width: 220px;
      height: 100vh;
      background-color: #343a40;
      position: fixed;
      top: 0;
      left: 0;
      color: white;
      padding-top: 20px;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
    }
    .sidebar a.active,
    .sidebar a:hover {
      background-color: #495057;
    }
    .main {
      margin-left: 220px;
      padding: 30px 20px;
      max-width: 1140px;
    }
    .kpi-box {
      border-radius: 5px;
      padding: 15px;
      color: white;
      text-align: center;
    }
    .kpi-blue { background-color: #17a2b8; }
    .kpi-green { background-color: #28a745; }
    .kpi-yellow { background-color: #ffc107; color: #333; }
    .card-header { font-weight: bold; }
    .comment-card {
      padding: 10px;
      border-left: 5px solid #17a2b8;
      margin-bottom: 10px;
      background-color: white;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
  </style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <h5 class="text-center mb-4">ðŸ“Š Chambua Dashboard</h5>
  <a href="#" class="active" onclick="showTab('dashboardTab', this)">Dashboard</a>
  <a href="#" onclick="showTab('trendTab', this)">Trends</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<!-- Main Content -->
<div class="main">
  <div class="dashboard-header">
    <h2>Clinic Feedback Summary</h2>
    <input type="date" id="dateFilter" class="form-control w-auto mx-auto" />
  </div>

  <!-- Dashboard Tab -->
  <div id="dashboardTab" class="tab-pane active">
    <div class="row">
      <div class="col-md-4">
        <div class="kpi-box kpi-blue">
          <h2 id="totalSubmissions">0</h2>
          <p>Total Submissions</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-box kpi-green">
          <h2 id="wouldRecommend">0</h2>
          <p>Would Recommend</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="kpi-box kpi-yellow">
          <h2 id="excellentCare">0</h2>
          <p>Excellent Care</p>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-primary text-white">Care Quality</div>
          <div class="card-body"><canvas id="careChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-info text-white">Wait Time</div>
          <div class="card-body"><canvas id="waitTimeChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">Staff Friendliness</div>
          <div class="card-body"><canvas id="friendlinessChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-success text-white">Would Recommend?</div>
          <div class="card-body"><canvas id="recommendChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header bg-secondary text-white">Client Comments & Suggestions</div>
      <div class="card-body" id="commentsSection">
        <div class="comment-card">Loading...</div>
      </div>
    </div>
  </div> <!-- End dashboardTab -->
  <!-- Trends Tab -->
  <div id="trendTab" class="tab-pane">
    <h4>Feedback Trends</h4>
    <p>Select variables and time range to view how feedback changes over time.</p>

    <div class="form-inline mb-3">
      <label class="mr-2">Start:</label>
      <input type="date" id="startDate" class="form-control mr-3"/>
      <label class="mr-2">End:</label>
      <input type="date" id="endDate" class="form-control mr-3"/>

      <label class="mr-2">Variable:</label>
      <select id="trendVariable" class="form-control">
        <option value="careQuality">Care Quality</option>
        <option value="waitTime">Wait Time</option>
        <option value="staffFriendliness">Staff Friendliness</option>
        <option value="recommendClinic">Would Recommend</option>
      </select>

      <button class="btn btn-primary ml-3" onclick="filterTrends()">Apply</button>
    </div>

    <div>
      <canvas id="trendChart" height="100"></canvas>
    </div>
  </div> <!-- End trendTab -->
</div> <!-- End main -->
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCA3TfnbfOm7PxJCH153zHJRTe1wYUrPLM",
    authDomain: "chambua-feedback-system.firebaseapp.com",
    projectId: "chambua-feedback-system",
    storageBucket: "chambua-feedback-system.appspot.com",
    messagingSenderId: "440404138384",
    appId: "1:440404138384:web:8f971a343eb6e467e23b15"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const charts = {};

  function showTab(tabId, el) {
    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
    el.classList.add('active');
  }

  function renderPieChart(canvasId, labels, data, colors) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    if (charts[canvasId]) charts[canvasId].destroy();

    charts[canvasId] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        plugins: [ChartDataLabels],
        legend: { position: 'bottom' },
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              let percentage = ((value / sum) * 100).toFixed(1) + "%";
              return percentage;
            },
            color: '#fff'
          }
        }
      }
    });
  }

  function updateDashboard(data) {
    const total = data.length;
    const recommendYes = data.filter(d => d.recommendClinic === "Yes").length;
    const excellentCare = data.filter(d => d.careQuality === "Excellent").length;

    document.getElementById("totalSubmissions").innerText = total;
    document.getElementById("wouldRecommend").innerText = recommendYes;
    document.getElementById("excellentCare").innerText = excellentCare;

    const careCount = countBy(data, "careQuality", ['Excellent', 'Good', 'Average', 'Poor']);
    const waitCount = countBy(data, "waitTime", ['Less than 15 minutes', '15â€“30 minutes', 'More than 30 minutes']);
    const friendCount = countBy(data, "staffFriendliness", ['Excellent', 'Good', 'Average', 'Poor']);
    const recCount = countBy(data, "recommendClinic", ['Yes', 'No']);

    renderPieChart("careChart", Object.keys(careCount), Object.values(careCount), ['#28a745', '#007bff', '#ffc107', '#dc3545']);
    renderPieChart("waitTimeChart", Object.keys(waitCount), Object.values(waitCount), ['#17a2b8', '#ffc107', '#dc3545']);
    renderPieChart("friendlinessChart", Object.keys(friendCount), Object.values(friendCount), ['#6f42c1', '#007bff', '#ffc107', '#dc3545']);
    renderPieChart("recommendChart", Object.keys(recCount), Object.values(recCount), ['#28a745', '#dc3545']);

    const commentContainer = document.getElementById("commentsSection");
    commentContainer.innerHTML = "";
    data.forEach(entry => {
      if (entry.additionalComments)
        commentContainer.innerHTML += `<div class="comment-card">${entry.additionalComments}</div>`;
    });
  }

  function countBy(data, field, categories) {
    const counts = {};
    categories.forEach(cat => counts[cat] = 0);
    data.forEach(row => {
      if (counts.hasOwnProperty(row[field])) counts[row[field]]++;
    });
    return counts;
  }

  db.collection("clinic_feedback").orderBy("submittedAt").onSnapshot(snapshot => {
    const allData = [];
    snapshot.forEach(doc => allData.push(doc.data()));
    const date = document.getElementById("dateFilter").value;
    const filtered = date ? allData.filter(entry => entry.submittedAt && entry.submittedAt.toDate().toISOString().startsWith(date)) : allData;
    updateDashboard(filtered);
    window.allFeedbackData = allData; // For trend use
  });

  function filterTrends() {
    const variable = document.getElementById("trendVariable").value;
    const start = new Date(document.getElementById("startDate").value);
    const end = new Date(document.getElementById("endDate").value);
    const raw = window.allFeedbackData || [];

    const filtered = raw.filter(entry => {
      if (!entry.submittedAt) return false;
      const d = entry.submittedAt.toDate();
      return (!isNaN(start) ? d >= start : true) && (!isNaN(end) ? d <= end : true);
    });

    const grouped = {};
    filtered.forEach(entry => {
      if (!entry.submittedAt || !entry[variable]) return;
      const dateStr = entry.submittedAt.toDate().toISOString().split("T")[0];
      if (!grouped[dateStr]) grouped[dateStr] = {};
      if (!grouped[dateStr][entry[variable]]) grouped[dateStr][entry[variable]] = 0;
      grouped[dateStr][entry[variable]]++;
    });

    const labels = Object.keys(grouped).sort();
    const categories = [...new Set([].concat(...Object.values(grouped).map(obj => Object.keys(obj))))];
    const datasets = categories.map(cat => ({
      label: cat,
      data: labels.map(label => grouped[label][cat] || 0),
      fill: false,
      borderColor: getColor(cat)
    }));

    const ctx = document.getElementById("trendChart").getContext("2d");
    if (charts.trendChart) charts.trendChart.destroy();
    charts.trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: { responsive: true, title: { display: true, text: 'Trends Over Time' } }
    });
  }

  function getColor(label) {
    const colors = {
      "Excellent": "#28a745",
      "Good": "#007bff",
      "Average": "#ffc107",
      "Poor": "#dc3545",
      "Yes": "#28a745",
      "No": "#dc3545"
    };
    return colors[label] || '#6c757d';
  }

  function logout() {
    window.location.href = "index.html";
  }
</script>
</body>
</html>
